#!/bin/bash

# https://buildkite.com/docs/pipelines/writing-build-scripts
set -euo pipefail

# common

function check_if_empty () {
    if [ "$1" == "" ]; then
        echo "$2 is empty"
        exit $3
    fi
}

pwd=$(pwd)

docker=${BUILDKITE_PLUGIN_DOTNET_NUGET_DOCKER:-docker}
debug=${BUILDKITE_PLUGIN_DOTNET_NUGET_DEBUG:-0}
if [ $debug -gt 0 ]; then
    set -euox pipefail

    if [ $debug -eq 2 ]; then
        env
    fi

    $docker version
    $docker ps
    whoami
    pwd
fi

tmp=.tmp
tmp=${BUILDKITE_PLUGIN_DOTNET_NUGET_DOCKER:-$tmp}

# dotnet runtime version
runtime="3.1"
runtime=${BUILDKITE_PLUGIN_DOTNET_NUGET_RUNTIME:-$runtime}
# docker image with dotnet runtime version 
image="dxdx/docker-builder-dotnet:$runtime"
image=${BUILDKITE_PLUGIN_DOTNET_NUGET_IMAGE:-$image}

src=${BUILDKITE_PLUGIN_DOTNET_NUGET_SRC:-src}
tpl=${BUILDKITE_PLUGIN_DOTNET_NUGET_TPL:-nuget.config.tpl}
version=${BUILDKITE_PLUGIN_DOTNET_NUGET_VERSION:-0.0.0}
dotnet=${BUILDKITE_PLUGIN_DOTNET_NUGET_DOTNET:-dotnet}
buildkite_agent=${BUILDKITE_PLUGIN_DOTNET_NUGET_AGENT:-buildkite-agent}
configuration=${BUILDKITE_PLUGIN_DOTNET_NUGET_CONFIGURATION:-Release}

# github
github_owner=$(echo "$BUILDKITE_REPO" | cut -d: -f 2 | cut -d/ -f 1)
github_repo=$(echo "$BUILDKITE_REPO" | cut -d: -f 2 | cut -d/ -f 2 | cut -d. -f 1)

# nuget
nuget_baseurl="https://nuget.pkg.github.com/${github_owner}/index.json"
nuget_baseurl=${NUGET_BASEURL:-$nuget_baseurl}
nuget_baseurl=${BUILDKITE_PLUGIN_DOTNET_NUGET_BASE_URL:-$nuget_baseurl}
nuget_auth_user=${BUILDKITE_PLUGIN_DOTNET_NUGET_AUTH_USER:-$NUGET_AUTH_USER}
nuget_auth_key=${BUILDKITE_PLUGIN_DOTNET_NUGET_AUTH_KEY:-$NUGET_AUTH_KEY}
pull=${BUILDKITE_PLUGIN_DOTNET_NUGET_PULL:-1}
if [ $pull -gt 0 ]; then
    $docker pull $image
fi
check_if_empty $nuget_baseurl NUGET_BASEURL 1
check_if_empty $nuget_auth_user NUGET_AUTH_USER 1
check_if_empty $nuget_auth_key NUGET_AUTH_KEY 1

export NUGET_BASEURL=$nuget_baseurl
export NUGET_AUTH_USER=$nuget_auth_user
export NUGET_AUTH_KEY=$nuget_auth_key

# folders
if [ -d "$src" ]; then
    if [ -e "$tpl" ]; then
        cp $tpl $src/NuGet.Config
    fi
elif [ -e "$tpl" ]; then
    cp $tpl NuGet.Config
fi

if [ ! -d "$tmp" ]; then
    mkdir $tmp -p
fi

function dotnet_execute() {
    wrkdir=/build
    if [ -d "$src" ]; then
        wrkdir=/build/$src
    fi
    env > .env
    # $docker run -e "NUGET_BASEURL=$nuget_baseurl" -e "NUGET_AUTH_USER=$nuget_auth_user" -e "NUGET_AUTH_KEY=$nuget_auth_key" -v $pwd:/build -w $wrkdir --entrypoint $dotnet $image $*
    $docker run --env-file .env -v $pwd:/build -w $wrkdir --entrypoint $dotnet $image $*
    # TODO: need to delete the file event when the run failed
    rm .env
}

if [ $debug -gt 0 ]; then
    dotnet_execute --info
    dotnet_execute --list-runtimes
    dotnet_execute --list-sdks
    dotnet_execute nuget --version
fi

# pack

dotnet_execute pack -c $configuration /p:Version=$version --include-symbols -o $tmp/$configuration

# push

echo push
